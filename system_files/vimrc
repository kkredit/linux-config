" Plugins

let data_dir = has('nvim') ? stdpath('data') . '/site' : '~/.vim'
if empty(glob(data_dir . '/autoload/plug.vim'))
  silent execute '!curl -fLo '.data_dir.'/autoload/plug.vim --create-dirs  https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
  autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif

call plug#begin('~/.vim/plugged')

" Formatting and colorschemes
Plug 'tomasiser/vim-code-dark'
Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'
Plug 'blueyed/vim-diminactive'

" Functionality
Plug 'machakann/vim-highlightedyank'
Plug 'easymotion/vim-easymotion'
Plug 'preservim/nerdtree'
Plug 'Xuyuanp/nerdtree-git-plugin'
Plug 'preservim/nerdcommenter'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-rhubarb'
Plug 'jiangmiao/auto-pairs'
Plug 'dkarter/bullets.vim'

" Neovim only
if has('nvim')
  " General setup
  set runtimepath^=~/.vim runtimepath+=~/.vim/after
  let &packpath=&runtimepath
  set completeopt=menu,menuone,noselect

  " Plugins
  " LSP and language tools
  Plug 'williamboman/mason.nvim'
  Plug 'williamboman/mason-lspconfig.nvim'
  Plug 'neovim/nvim-lspconfig'
  Plug 'WhoIsSethDaniel/mason-tool-installer.nvim', {'do': ':MasonToolsInstall'}
  Plug 'nvim-treesitter/nvim-treesitter', {'do': ':TSUpdate'}
  Plug 'jose-elias-alvarez/null-ls.nvim'
  Plug 'mracos/mermaid.vim'

  " Completion
  Plug 'hrsh7th/cmp-nvim-lsp'
  Plug 'hrsh7th/cmp-buffer'
  Plug 'hrsh7th/cmp-path'
  Plug 'hrsh7th/cmp-cmdline'
  Plug 'hrsh7th/nvim-cmp'
  Plug 'hrsh7th/cmp-vsnip'
  Plug 'hrsh7th/vim-vsnip'
  Plug 'rafamadriz/friendly-snippets'

  " Themes
  Plug 'Shatur/neovim-ayu'
  Plug 'vigoux/oak'
  Plug 'olimorris/onedarkpro.nvim'

  " Other
  Plug 'ggandor/leap.nvim'
  Plug 'folke/which-key.nvim'
  Plug 'folke/trouble.nvim'
  Plug 'nvim-lua/plenary.nvim'
  Plug 'lewis6991/gitsigns.nvim'
  Plug 'nvim-telescope/telescope.nvim'
  Plug 'nvim-telescope/telescope-fzf-native.nvim', { 'do': 'cmake -S. -Bbuild -DCMAKE_BUILD_TYPE=Release && cmake --build build --config Release && cmake --install build --prefix build' }
endif

call plug#end()

" Plugin configuration
let g:NERDTreeGitStatusConcealBrackets = 1
let g:NERDTreeGitStatusIndicatorMapCustom = {
                \ 'Modified'  :'',
                \ 'Staged'    :'',
                \ 'Untracked' :'',
                \ 'Renamed'   :'',
                \ 'Unmerged'  :'',
                \ 'Deleted'   :'﫧',
                \ 'Dirty'     :'',
                \ 'Ignored'   :'☒',
                \ 'Clean'     :'✔︎',
                \ 'Unknown'   :'?',
                \ }
let g:highlightedyank_highlight_duration = 150
let g:airline_powerline_fonts = 1
let g:airline#extensions#tabline#enabled = 1
let g:airline_detect_spell = 0
let g:airline_left_sep = ""
let g:airline_left_alt_sep = "|"
let g:airline_right_sep = ""
let g:airline_right_alt_sep = "|"
let g:gitblame_enabled = 0
let g:auto_session_pre_save_cmds = ["tabdo NERDTreeClose"]
" Close the tab if NERDTree is the only window remaining in it.
autocmd BufEnter * if winnr('$') == 1 && exists('b:NERDTree') && b:NERDTree.isTabTree() | quit | endif
" If another buffer tries to replace NERDTree, put it in the other window, and bring back NERDTree.
autocmd BufEnter * if bufname('#') =~ 'NERD_tree_\d\+' && bufname('%') !~ 'NERD_tree_\d\+' && winnr('$') > 1 |
    \ let buf=bufnr() | buffer# | execute "normal! \<C-W>w" | execute 'buffer'.buf | endif
" Completion (nvim-compe)
let g:compe = {}
let g:compe.enabled = v:true
let g:compe.autocomplete = v:true
let g:compe.source = {}
let g:compe.source.path = v:true
let g:compe.source.buffer = v:true
let g:compe.source.calc = v:true
let g:compe.source.nvim_lsp = v:true
let g:compe.source.treesitter = v:true
" Bullets.vim
let g:bullets_enabled_file_types = [
    \ 'markdown',
    \ 'text',
    \ 'gitcommit',
    \ 'scratch'
    \]


" Keymappings
let mapleader = " "
let timeoutlen = 500

nnoremap <silent> <leader>w :w<CR>
nnoremap <leader>W :wq<CR>
nnoremap <silent> <leader>q :q<CR>
nnoremap <silent> <leader>1 :source $MYVIMRC<CR>
inoremap jk <esc>
inoremap kj <esc>
nnoremap <silent> <leader>d :NERDTreeFind<CR>
nnoremap <silent> <leader>/ :NERDTreeToggle<CR>
nnoremap <silent> <leader>, :noh<CR>:cclose<CR>:lclose<CR>:NERDTreeClose<CR>:TroubleClose<CR><C-l>
nnoremap <leader>z za<CR>
nnoremap <leader>y "+y
vnoremap <leader>y "+y
nnoremap <leader>p "+p
nnoremap <leader>i i_<Esc>r
nnoremap <leader>rw ciw<C-R>0<ESC>
vnoremap <leader>a :CocAction<CR>
nnoremap <leader>a :CocAction<CR>
nnoremap <leader>fr :let @+=expand('%')<CR>
nnoremap <leader>ff :let @+=expand('%:p')<CR>
nnoremap <leader>fn :let @+=join([expand('%'),line(".")], ':')<CR>
nnoremap <leader>U :PlugUpdate<CR>:MasonToolsUpdate<CR>:TSUpdate all<CR>

let g:AutoPairsShortcutFastWrap = '<C-e>'
let g:AutoPairsShortcutJump = '<C-n>'

nnoremap <leader>gd :Gdiffsplit<CR>
nnoremap <leader>gD :G diff %<CR>
nnoremap <leader>gm :G mergetool<CR>
nnoremap <leader>gb :G blame<CR>
nnoremap <leader>gl :GBrowse<CR>
vnoremap <leader>gl :GBrowse<CR>

nnoremap <C-p> :<cmd>Telescope find_files<cr>
nnoremap <leader>; <cmd>Telescope command_history<cr>
nnoremap <leader>s <cmd>Telescope live_grep<cr>
nnoremap <leader>S <cmd>Telescope grep_string<cr>
vnoremap <leader>s "zy<cmd>exec 'Telescope grep_string search=' . escape(@z, ' ')<cr>
nnoremap <leader>kf <cmd>Trouble document_diagnostics<cr>
nnoremap <leader>kw <cmd>Trouble workspace_diagnostics<cr>
nnoremap <leader>kq <cmd>Trouble quickfix<cr>
nnoremap <leader>kl <cmd>Trouble loclist<cr>
nnoremap <leader>kd <cmd>Trouble lsp_definitions<cr>
nnoremap <leader>kD <cmd>Trouble lsp_type_definitions<cr>
nnoremap gr <cmd>Trouble lsp_references<cr>
nnoremap <leader>kr <cmd>Telescope lsp_references<cr>
nnoremap <leader>kgs <cmd>Telescope git_status<cr>
nnoremap <leader>kgc <cmd>Telescope git_commits<cr>
nnoremap <leader>kgb <cmd>Telescope git_branches<cr>
nnoremap <leader>kt <cmd>Telescope treesitter<cr>
nnoremap <leader>kk <cmd>Telescope builtin<cr>

" Colors
syntax on
set t_Co=256
set t_ut=
if has('nvim')
  let g:airline_theme = 'tomorrow'
  colorscheme oak
  hi MatchParen ctermbg=Brown guibg=Brown
else
  let g:airline_theme = 'jellybeans'
  colorscheme codedark
  hi ColorColumn ctermbg=0 guibg=#333333
endif
if exists('+termguicolors')
  let &t_8f = "\<Esc>[38;2;%lu;%lu;%lum"
  let &t_8b = "\<Esc>[48;2;%lu;%lu;%lum"
  set termguicolors
endif

nnoremap <leader>v1 :set background=dark<CR>:let g:airline_theme = 'tomorrow'<CR>:colorscheme oak<CR><C-l>
nnoremap <leader>v2 :set background=dark<CR>:let g:airline_theme = 'jellybeans'<CR>:colorscheme ayu<CR><C-l>
nnoremap <leader>v3 :set background=dark<CR>:let g:airline_theme = 'jellybeans'<CR>:colorscheme codedark<CR><C-l>
nnoremap <leader>v6 :set background=light<CR>:colorscheme onedarkpro<CR><C-l>

" Indentation & tabs
set backspace=indent,eol,start
set autoindent
set smartindent
set tabstop=2
set shiftwidth=2
set expandtab
set smarttab
autocmd FileType make setlocal noexpandtab
autocmd FileType go setlocal noexpandtab
set foldlevel=999

" Display & format
set cursorline
set number
"set relativenumber
"autocmd InsertEnter * :set norelativenumber
"autocmd InsertLeave * :set relativenumber
"nnoremap <leader>vl :setl relativenumber!<CR>
"set textwidth=100
set formatoptions-=tc
set wrapmargin=2
set showmatch
set encoding=utf-8
scriptencoding utf-8
set listchars=tab:»\ ,space:·,trail:-
"set list

" Splits and windows
set splitbelow
set splitright
nnoremap J :5winc +<CR>
nnoremap K :5winc -<CR>
nnoremap L :5winc ><CR>
nnoremap H :5winc <<CR>
" jump to previous window
nnoremap <silent> <leader><BS> <C-W>p
" close vim if a QFL is the only remaining window
" see https://stackoverflow.com/a/7477056
aug QFClose
  au!
  au WinEnter * if winnr('$') == 1 && &buftype == "quickfix"|q|endif
aug END
nnoremap <leader>bo :%bd \| e# \| bd# <CR> \|`"
nnoremap <leader>b<BS> <C-^>
nnoremap <leader>bn :bn<CR>
nnoremap <leader>bN :bN<CR>
nnoremap <leader>bd :bd<CR>

" Markdown settings
autocmd Filetype markdown call SetMarkdownOptions()
function SetMarkdownOptions()
  set textwidth=80
  set colorcolumn=81
  set formatoptions+=tc
  " rewrap current paragraph: vip | gq
endfunction

" Git commit settings
autocmd Filetype gitcommit call SetGitcommitOptions()
function SetGitcommitOptions()
  set textwidth=72
  set colorcolumn=73
  set colorcolumn+=51
  $
  read !echo '\# Recent commits:'; git log --oneline --no-decorate -8 | sed -e 's/^/\# /g'
  1
  "startinsert
endfunction

" Git rebase settings
autocmd Filetype gitrebase call SetGitrebaseOptions()
function SetGitrebaseOptions()
  call setreg('p', "0dt ipick\<esc>j0")
  call setreg('r', "0dt ireword\<esc>j0")
  call setreg('e', "0dt iedit\<esc>j0")
  call setreg('s', "0dt isquash\<esc>j0")
  call setreg('f', "0dt ifixup\<esc>j0")
endfunction

" Search
set hlsearch
set incsearch
set ignorecase
set smartcase

" Browse and scroll
set scrolloff=5
set laststatus=2
" Prevent Vim from clobbering the scrollback buffer. See
" http://www.shallowsky.com/linux/noaltscreen.html
set t_ti= t_te=

" Open at same line as was last opened
autocmd BufReadPost * if &filetype !~ 'gitcommit' && line("'\"") > 0 && line("'\"") <= line("$")
    \| exe "normal! g'\"" | endif

"" Highlight whitespace at ends of lines
"highlight ExtraWhitespace ctermbg=red guibg=red
"match ExtraWhitespace /\s\+$/
"autocmd BufWinEnter * match ExtraWhitespace /\s\+$/
"autocmd InsertEnter * match ExtraWhitespace /\s\+\%#\@<!$/
"autocmd InsertLeave * match ExtraWhitespace /\s\+$/
"autocmd BufWinLeave * call clearmatches()
"" Remove trailing whitespace except in markdown files
let exceptlist = ['markdown', 'rst']
autocmd BufWritePre * if index(exceptlist, &ft) < 0 | :%s/\s\+$//e

" Miscellaneous
set undofile
set autoread
