" Plugins

let data_dir = has('nvim') ? stdpath('data') . '/site' : '~/.vim'
if empty(glob(data_dir . '/autoload/plug.vim'))
  silent execute '!curl -fLo '.data_dir.'/autoload/plug.vim --create-dirs  https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
  autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif

call plug#begin('~/.vim/plugged')

" Formatting and colorschemes
Plug 'tomasiser/vim-code-dark'
Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'
Plug 'blueyed/vim-diminactive'

" Functionality
Plug 'machakann/vim-highlightedyank'
Plug 'junegunn/fzf', { 'do': { -> fzf#install() } }
Plug 'junegunn/fzf.vim'
Plug 'justinmk/vim-sneak'
Plug 'easymotion/vim-easymotion'
Plug 'preservim/nerdtree'
Plug 'preservim/nerdcommenter'
Plug 'mattn/vim-goimports'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-rhubarb'
Plug 'jiangmiao/auto-pairs'
Plug 'dkarter/bullets.vim'

" Neovim only
if has('nvim')
  Plug 'nvim-treesitter/nvim-treesitter', {'do': ':TSUpdate'}
  Plug 'neovim/nvim-lspconfig'
  Plug 'williamboman/nvim-lsp-installer'
  Plug 'folke/which-key.nvim'

  Plug 'hrsh7th/cmp-nvim-lsp'
  Plug 'hrsh7th/cmp-buffer'
  Plug 'hrsh7th/cmp-path'
  Plug 'hrsh7th/cmp-cmdline'
  Plug 'hrsh7th/nvim-cmp'
  Plug 'hrsh7th/cmp-vsnip'
  Plug 'hrsh7th/vim-vsnip'
  Plug 'rafamadriz/friendly-snippets'

  Plug 'nvim-lua/plenary.nvim'
  Plug 'lewis6991/gitsigns.nvim'
  Plug 'neoclide/coc.nvim', { 'branch': 'release', 'do': ':CocInstall coc-spell-checker coc-diagnostic' },

  Plug 'Shatur/neovim-ayu'
  Plug 'vigoux/oak'
  Plug 'olimorris/onedarkpro.nvim'
endif

call plug#end()

" Language server setup helper
command! MyLspInstall execute 'LspInstall bashls' | :exe 'LspInstall dockerls' | :exe 'LspInstall gopls' | :exe 'LspInstall hls' | :exe 'LspInstall html' | :exe 'LspInstall jsonls' | :exe 'LspInstall ltex' | :exe 'LspInstall pyright' | :exe 'LspInstall terraformls' | :exe 'LspInstall tsserver' | :exe 'LspInstall vimls' | :exe 'LspInstall yamlls' | :exe 'LspInstall tflint' | :exe 'LspInstall marksman'

" Plugin configuration
let g:highlightedyank_highlight_duration = 150
let g:fzf_layout = { 'down': '30%' }
let g:airline_powerline_fonts = 1
let g:airline#extensions#tabline#enabled = 1
let g:airline_detect_spell = 0
let g:airline_left_sep = ""
let g:airline_left_alt_sep = "|"
let g:airline_right_sep = ""
let g:airline_right_alt_sep = "|"
let g:gitblame_enabled = 0
let g:auto_session_pre_save_cmds = ["tabdo NERDTreeClose"]
" Close the tab if NERDTree is the only window remaining in it.
autocmd BufEnter * if winnr('$') == 1 && exists('b:NERDTree') && b:NERDTree.isTabTree() | quit | endif
" If another buffer tries to replace NERDTree, put it in the other window, and bring back NERDTree.
autocmd BufEnter * if bufname('#') =~ 'NERD_tree_\d\+' && bufname('%') !~ 'NERD_tree_\d\+' && winnr('$') > 1 |
    \ let buf=bufnr() | buffer# | execute "normal! \<C-W>w" | execute 'buffer'.buf | endif
" Fzf -- Rg command with preview window
command! -bang -nargs=* Rg
  \ call fzf#vim#grep(
  \   'rg --column --line-number --no-heading --color=always --smart-case -- '.shellescape(<q-args>), 1,
  \   fzf#vim#with_preview(), <bang>0)
" Completion (nvim-compe)
let g:compe = {}
let g:compe.enabled = v:true
let g:compe.autocomplete = v:true
let g:compe.source = {}
let g:compe.source.path = v:true
let g:compe.source.buffer = v:true
let g:compe.source.calc = v:true
let g:compe.source.nvim_lsp = v:true
let g:compe.source.treesitter = v:true
" Bullets.vim
let g:bullets_enabled_file_types = [
    \ 'markdown',
    \ 'text',
    \ 'gitcommit',
    \ 'scratch'
    \]


" Keymappings
let mapleader = " "
let timeoutlen = 500

nnoremap <silent> <leader>w :w<CR>
nnoremap <leader>W :wq<CR>
nnoremap <silent> <leader>q :q<CR>
nnoremap <silent> <leader>1 :source $MYVIMRC<CR>
nnoremap <C-p> :<C-u>FZF<CR>
nnoremap <leader>; :History:<CR>
inoremap jk <esc>
inoremap kj <esc>
nnoremap <silent> <leader>d :NERDTreeFind<CR>
nnoremap <silent> <leader>/ :NERDTreeToggle<CR>
nnoremap <silent> <leader>, :noh<CR>:cclose<CR>:lclose<CR>:NERDTreeClose<CR><C-l>
nnoremap <leader>z za<CR>
nnoremap <leader>y "+y
vnoremap <leader>y "+y
nnoremap <leader>p "+p
nnoremap <leader>i i_<Esc>r
nnoremap <leader>s :Rg<CR>
nnoremap <leader>rw ciw<C-R>0<ESC>
vnoremap <leader>a :CocAction<CR>
nnoremap <leader>a :CocAction<CR>
nnoremap <leader>fr :let @+=expand('%')<CR>
nnoremap <leader>ff :let @+=expand('%:p')<CR>
nnoremap <leader>fn :let @+=join([expand('%'),line(".")], ':')<CR>
nnoremap <leader>gd :G diff %<CR>
nnoremap <leader>gm :G mergetool<CR>
nnoremap <leader>gb :G blame<CR>
nnoremap <leader>gl :GBrowse<CR>
vnoremap <leader>gl :GBrowse<CR>

" Colors
syntax on
set t_Co=256
set t_ut=
if has('nvim')
  let g:airline_theme = 'tomorrow'
  colorscheme oak
  hi MatchParen ctermbg=Brown guibg=Brown
else
  let g:airline_theme = 'jellybeans'
  colorscheme codedark
  hi ColorColumn ctermbg=0 guibg=#333333
endif
if exists('+termguicolors')
  let &t_8f = "\<Esc>[38;2;%lu;%lu;%lum"
  let &t_8b = "\<Esc>[48;2;%lu;%lu;%lum"
  set termguicolors
endif

nnoremap <leader>v1 :set background=dark<CR>:let g:airline_theme = 'tomorrow'<CR>:colorscheme oak<CR><C-l>
nnoremap <leader>v2 :set background=dark<CR>:let g:airline_theme = 'jellybeans'<CR>:colorscheme ayu<CR><C-l>
nnoremap <leader>v3 :set background=dark<CR>:let g:airline_theme = 'jellybeans'<CR>:colorscheme codedark<CR><C-l>
nnoremap <leader>v6 :set background=light<CR>:colorscheme onedarkpro<CR><C-l>

" Indentation & tabs
set backspace=indent,eol,start
set autoindent
set smartindent
set tabstop=2
set shiftwidth=2
set expandtab
set smarttab
autocmd FileType make setlocal noexpandtab
autocmd FileType go setlocal noexpandtab
set foldlevel=999

" Display & format
set cursorline
set number
"set relativenumber
"autocmd InsertEnter * :set norelativenumber
"autocmd InsertLeave * :set relativenumber
"nnoremap <leader>vl :setl relativenumber!<CR>
"set textwidth=100
set formatoptions-=tc
set wrapmargin=2
set showmatch

" Splits and windows
set splitbelow
set splitright
nnoremap J :5winc +<CR>
nnoremap K :5winc -<CR>
nnoremap L :5winc ><CR>
nnoremap H :5winc <<CR>
" jump to previous window
nnoremap <silent> <leader><BS> <C-W>p
" close vim if a QFL is the only remaining window
" see https://stackoverflow.com/a/7477056
aug QFClose
  au!
  au WinEnter * if winnr('$') == 1 && &buftype == "quickfix"|q|endif
aug END
nnoremap <leader>bo :%bd \| e# \| bd# <CR> \|`"
nnoremap <leader>b<BS> <C-^>
nnoremap <leader>bn :bn<CR>
nnoremap <leader>bN :bN<CR>
nnoremap <leader>bd :bd<CR>

" Markdown settings
autocmd Filetype markdown call SetMarkdownOptions()
function SetMarkdownOptions()
  set textwidth=100
  set colorcolumn=101
  set formatoptions+=tc
  " rewrap current paragraph: vip | gq
endfunction

" Golang settings
autocmd Filetype go call SetGolangOptions()
function SetGolangOptions()
  :nnoremap <leader>t :w<CR>:!go fmt %<CR><CR>
  :let g:goimports_local = trim(system('cd '. shellescape(expand('%:h')) .' && go list -m'))
endfunction

" Git commit settings
autocmd Filetype gitcommit call SetGitcommitOptions()
function SetGitcommitOptions()
  set textwidth=72
  set colorcolumn=73
  set colorcolumn+=51
  $
  read !echo '\# Recent commits:'; git log --oneline --no-decorate -8 | sed -e 's/^/\# /g'
  1
  "startinsert
endfunction

" Git rebase settings
autocmd Filetype gitrebase call SetGitrebaseOptions()
function SetGitrebaseOptions()
  call setreg('p', "0dt ipick\<esc>j0")
  call setreg('r', "0dt ireword\<esc>j0")
  call setreg('e', "0dt iedit\<esc>j0")
  call setreg('s', "0dt isquash\<esc>j0")
  call setreg('f', "0dt ifixup\<esc>j0")
endfunction

" Search
set hlsearch
set incsearch
set ignorecase
set smartcase

" Browse and scroll
set scrolloff=5
set laststatus=2
" Prevent Vim from clobbering the scrollback buffer. See
" http://www.shallowsky.com/linux/noaltscreen.html
set t_ti= t_te=

" Open at same line as was last opened
autocmd BufReadPost * if &filetype !~ 'gitcommit' && line("'\"") > 0 && line("'\"") <= line("$")
    \| exe "normal! g'\"" | endif

"" Spell
"set spell spelllang=en_us
"hi clear SpellBad
"hi SpellBad cterm=underline
"hi clear SpellCap
"hi clear SpellLocal
"hi clear SpellRare

"" Highlight whitespace at ends of lines
"highlight ExtraWhitespace ctermbg=red guibg=red
"match ExtraWhitespace /\s\+$/
"autocmd BufWinEnter * match ExtraWhitespace /\s\+$/
"autocmd InsertEnter * match ExtraWhitespace /\s\+\%#\@<!$/
"autocmd InsertLeave * match ExtraWhitespace /\s\+$/
"autocmd BufWinLeave * call clearmatches()
"" Remove trailing whitespace except in markdown files
let exceptlist = ['markdown', 'rst']
autocmd BufWritePre * if index(exceptlist, &ft) < 0 | :%s/\s\+$//e

" Miscellaneous
set undofile
set autoread

